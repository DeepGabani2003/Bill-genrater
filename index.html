<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jewelry Bill & Summary</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body {
    background: #f9f9f9;
    font-family: 'Times New Roman', serif;
    padding: 20px;
  }
  h1 {
    text-align: center;
    font-weight: bold;
    margin-bottom: 20px;
  }
  .bill-form, .summary-section {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #000;
    padding: 8px;
    text-align: left;
  }
  img {
    max-width: 100px;
    max-height: 100px;
    border-radius: 8px;
  }
  .btn {
    border-radius: 5px;
    margin: 2px;
  }
</style>
</head>
<body>

<h1>Jewelry Bill & Summary</h1>

<div class="bill-form">
  <h4>Add New Bill</h4>
  <div class="row g-3">
    <div class="col-md-4"><input id="billNo" class="form-control" placeholder="Bill No"></div>
    <div class="col-md-4"><input id="date" type="date" class="form-control"></div>
    <div class="col-md-4"><input id="kt" class="form-control" placeholder="KT"></div>
    <div class="col-md-4"><input id="gross" type="number" step="0.001" class="form-control" placeholder="Gross"></div>
    <div class="col-md-4"><input id="ctw" type="number" step="0.001" class="form-control" placeholder="CTW"></div>
    <div class="col-md-4"><input id="dwt" type="number" step="0.001" class="form-control" placeholder="DWT"></div>
    <div class="col-md-4"><input id="net" type="number" step="0.001" class="form-control" placeholder="Net"></div>
    <div class="col-md-4"><input id="fine" type="number" step="0.001" class="form-control" placeholder="Fine"></div>
    <div class="col-md-4"><input id="labour" type="number" step="0.001" class="form-control" placeholder="Labour (Rs)"></div>
    <div class="col-md-12">
      <label>Upload Image</label>
      <input id="image" type="file" accept="image/*" class="form-control">
    </div>
    <div class="col-md-12 text-end">
      <button class="btn btn-primary" onclick="addBill()">Add Bill</button>
    </div>
  </div>
</div>

<div class="summary-section">
  <h4>Bill Summary</h4>
  <div class="mb-3">
    <button class="btn btn-success" onclick="downloadSummaryPDF()">Download Summary PDF</button>
    <button class="btn btn-warning" onclick="downloadSummaryExcel()">Download Excel</button>
    <button class="btn btn-dark" onclick="printAllBills()">ðŸ–¨ Print All Bills</button>
  </div>
  <div class="table-responsive">
    <table id="summaryTable">
      <thead>
        <tr>
          <th>Image</th>
          <th>Bill No</th>
          <th>Date</th>
          <th>KT</th>
          <th>Gross</th>
          <th>CTW</th>
          <th>DWT</th>
          <th>Net</th>
          <th>Fine</th>
          <th>Labour</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>
</div>

<script>
let bills = JSON.parse(localStorage.getItem("bills")) || [];

document.getElementById("image").addEventListener("change", function(e){
  const reader = new FileReader();
  reader.onload = () => this.dataset.base64 = reader.result;
  reader.readAsDataURL(e.target.files[0]);
});

function addBill() {
  const imageInput = document.getElementById("image");
  const imageBase64 = imageInput.dataset.base64 || "";

  const bill = {
    billNo: document.getElementById("billNo").value,
    date: document.getElementById("date").value,
    kt: document.getElementById("kt").value,
    gross: parseFloat(document.getElementById("gross").value) || 0,
    ctw: parseFloat(document.getElementById("ctw").value) || 0,
    dwt: parseFloat(document.getElementById("dwt").value) || 0,
    net: parseFloat(document.getElementById("net").value) || 0,
    fine: parseFloat(document.getElementById("fine").value) || 0,
    labour: parseFloat(document.getElementById("labour").value) || 0,
    image: imageBase64
  };

  bills.push(bill);
  localStorage.setItem("bills", JSON.stringify(bills));
  renderSummary();
  clearForm();
}

function clearForm() {
  document.querySelectorAll('.form-control').forEach(el => el.value = "");
  delete document.getElementById("image").dataset.base64;
}

function renderSummary() {
  const tbody = document.getElementById("summaryBody");
  tbody.innerHTML = bills.map((b, i) => `
    <tr>
      <td>${b.image ? `<img src="${b.image}" alt="Bill Image">` : ''}</td>
      <td>${b.billNo}</td>
      <td>${b.date}</td>
      <td>${b.kt}K</td>
      <td>${b.gross.toFixed(3)}</td>
      <td>${b.ctw.toFixed(3)}</td>
      <td>${b.dwt.toFixed(3)}</td>
      <td>${b.net.toFixed(3)}</td>
      <td>${b.fine.toFixed(3)}</td>
      <td>â‚¹${b.labour.toFixed(3)}</td>
      <td>
        <button class="btn btn-sm btn-info" onclick="printBill(${i})">Print</button>
        <button class="btn btn-sm btn-danger" onclick="deleteBill(${i})">Delete</button>
      </td>
    </tr>
  `).join("");
}

function deleteBill(index){
  if(confirm("Delete this bill?")){
    bills.splice(index,1);
    localStorage.setItem("bills", JSON.stringify(bills));
    renderSummary();
  }
}

function printBill(i){
  const b = bills[i];
  const w = window.open("");
  w.document.write(`
  <html><head><title>Bill ${b.billNo}</title>
  <style>
    body{font-family:'Times New Roman',serif;padding:20px;}
    table{width:100%;border-collapse:collapse;margin-top:15px;}
    th,td{border:1px solid #000;padding:8px;text-align:left;}
  </style></head><body>
  <h2>Jewelry Bill - ${b.billNo}</h2>
  ${b.image ? `<img src="${b.image}" style="max-width:200px;"><br>` : ''}
  <table>
    <tr><th>Date</th><td>${b.date}</td></tr>
    <tr><th>KT</th><td>${b.kt}</td></tr>
    <tr><th>Gross</th><td>${b.gross}</td></tr>
    <tr><th>CTW</th><td>${b.ctw}</td></tr>
    <tr><th>DWT</th><td>${b.dwt}</td></tr>
    <tr><th>Net</th><td>${b.net}</td></tr>
    <tr><th>Fine</th><td>${b.fine}</td></tr>
    <tr><th>Labour</th><td>â‚¹${b.labour}</td></tr>
  </table>
  </body></html>`);
  w.document.close(); w.focus(); w.print(); w.close();
}

function printAllBills(){
  const w = window.open("");
  let html = `<html><head><title>All Bills</title>
  <style>
    body{font-family:'Times New Roman',serif;padding:20px;}
    .bill{margin-bottom:30px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border:1px solid #000;padding:6px;text-align:left;}
    img{max-width:150px;margin-bottom:10px;}
  </style></head><body>
  <h1>All Bills Summary</h1>`;

  bills.forEach(b => {
    html += `<div class="bill">
      <h4>Bill No: ${b.billNo}</h4>
      ${b.image ? `<img src="${b.image}" alt="bill">` : ''}
      <table>
        <tr><th>Date</th><td>${b.date}</td></tr>
        <tr><th>KT</th><td>${b.kt}</td></tr>
        <tr><th>Gross</th><td>${b.gross}</td></tr>
        <tr><th>CTW</th><td>${b.ctw}</td></tr>
        <tr><th>DWT</th><td>${b.dwt}</td></tr>
        <tr><th>Net</th><td>${b.net}</td></tr>
        <tr><th>Fine</th><td>${b.fine}</td></tr>
        <tr><th>Labour</th><td>â‚¹${b.labour}</td></tr>
      </table>
    </div>`;
  });
  html += "</body></html>";
  w.document.write(html);
  w.document.close(); w.focus(); w.print(); w.close();
}

function downloadSummaryPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Kirtijewels Bill Summary", 20, 20);
  const columns = ["Bill No","Date","KT","Gross","CTW","DWT","Net","Fine","Labour"];
  const rows = bills.map(b => [b.billNo,b.date,b.kt+"K",b.gross.toFixed(3),b.ctw.toFixed(3),b.dwt.toFixed(3),b.net.toFixed(3),b.fine.toFixed(3),"â‚¹"+b.labour.toFixed(3)]);
  doc.autoTable({ head:[columns], body:rows, startY:30 });
  doc.save("Bill_Summary.pdf");
}

function downloadSummaryExcel(){
  const wb = XLSX.utils.book_new();
  const dataForExcel = bills.map(b => ({
    "Bill No": b.billNo, "Date": b.date, "KT": b.kt+"K",
    "Gross": b.gross.toFixed(3), "CTW": b.ctw.toFixed(3),
    "DWT": b.dwt.toFixed(3), "Net": b.net.toFixed(3),
    "Fine": b.fine.toFixed(3), "Labour": b.labour.toFixed(3)
  }));
  const ws = XLSX.utils.json_to_sheet(dataForExcel);
  XLSX.utils.book_append_sheet(wb, ws, "Summary");
  XLSX.writeFile(wb, "Bill_Summary.xlsx");
}

renderSummary();
</script>
</body>
</html>
