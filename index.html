<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jewelry Bill & Summary</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body {
  font-family: 'Poppins', sans-serif;
  margin: 20px;
  background: #fafafa;
}
h2 {
  text-align: center;
  color: #333;
}
.card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
  padding: 20px;
  margin-bottom: 20px;
}
input, select, button {
  margin: 5px;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
}
button {
  background: #007bff;
  color: #fff;
  cursor: pointer;
}
button:hover {
  background: #0056b3;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  background: #fff;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}
th {
  background: #007bff;
  color: white;
}
img.preview {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 8px;
}
.summary-btns {
  text-align: center;
  margin: 15px 0;
}
</style>
</head>
<body>

<h2>Jewelry Bill Generator</h2>

<div class="card">
  <label>Bill No: <input type="text" id="billNo" placeholder="Enter Bill No"></label>
  <label>Date: <input type="date" id="date"></label>
  <label>KT: <input type="number" id="kt" placeholder="e.g. 22"></label><br>
  <label>Gross Wt: <input type="number" id="gross" step="0.001"></label>
  <label>CTW: <input type="number" id="ctw" step="0.001"></label>
  <label>DWT: <input type="number" id="dwt" step="0.001"></label>
  <label>Labour (‚Çπ): <input type="number" id="labour" step="0.01"></label><br>
  <label>Upload Image: <input type="file" id="imageUpload" accept="image/*"></label>
  <button onclick="addBill()">Add Bill</button>
</div>

<div class="card">
  <h3>Summary</h3>
  <div class="summary-btns">
    <button onclick="printAllBills()">üñ®Ô∏è Print All</button>
    <button onclick="downloadSummaryPDF()">üìÑ Download PDF</button>
    <button onclick="downloadSummaryExcel()">üìä Download Excel</button>
  </div>

  <table id="summaryTable">
    <thead>
      <tr>
        <th>Bill No</th><th>Date</th><th>KT</th><th>Gross</th>
        <th>CTW</th><th>DWT</th><th>Net</th><th>Fine</th>
        <th>Labour (‚Çπ)</th><th>Image</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th colspan="7">Total</th>
        <th id="totalFine">0.000</th>
        <th id="totalLabour">0.00</th>
        <th colspan="2"></th>
      </tr>
    </tfoot>
  </table>
</div>

<script>
let bills = JSON.parse(localStorage.getItem('bills') || '[]');
renderSummary();

document.getElementById('imageUpload').addEventListener('change', function(e){
  const reader = new FileReader();
  reader.onload = function(){
    document.getElementById('imageUpload').setAttribute('data-img', reader.result);
  };
  reader.readAsDataURL(e.target.files[0]);
});

function addBill(){
  const billNo = document.getElementById('billNo').value.trim();
  const date = document.getElementById('date').value;
  const kt = parseFloat(document.getElementById('kt').value);
  const gross = parseFloat(document.getElementById('gross').value);
  const ctw = parseFloat(document.getElementById('ctw').value);
  const dwt = parseFloat(document.getElementById('dwt').value);
  const labour = parseFloat(document.getElementById('labour').value);
  const image = document.getElementById('imageUpload').getAttribute('data-img') || '';

  if(!billNo || !kt || !gross) return alert('Please fill mandatory fields!');

  const net = gross - (ctw + dwt);
  const fine = net * (kt / 24);

  bills.push({ billNo, date, kt, gross, ctw, dwt, net, fine, labour, image });
  localStorage.setItem('bills', JSON.stringify(bills));
  renderSummary();
  clearInputs();
}

function clearInputs(){
  document.querySelectorAll('#billNo,#gross,#ctw,#dwt,#labour,#kt,#imageUpload').forEach(e=>e.value='');
  document.getElementById('imageUpload').removeAttribute('data-img');
}

function renderSummary(){
  const tbody = document.querySelector('#summaryTable tbody');
  tbody.innerHTML = '';
  let totalFine = 0, totalLabour = 0;

  bills.forEach((b,i)=>{
    totalFine += b.fine;
    totalLabour += b.labour;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${b.billNo}</td>
      <td>${b.date}</td>
      <td>${b.kt}K</td>
      <td>${b.gross.toFixed(3)}</td>
      <td>${b.ctw.toFixed(3)}</td>
      <td>${b.dwt.toFixed(3)}</td>
      <td>${b.net.toFixed(3)}</td>
      <td>${b.fine.toFixed(3)}</td>
      <td>‚Çπ${b.labour.toFixed(2)}</td>
      <td>${b.image ? `<img src="${b.image}" class="preview">` : '-'}</td>
      <td>
        <button onclick="printBill(${i})">üñ®Ô∏è</button>
        <button onclick="deleteBill(${i})">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('totalFine').textContent = totalFine.toFixed(3);
  document.getElementById('totalLabour').textContent = totalLabour.toFixed(2);
}

function deleteBill(i){
  if(confirm("Delete this bill?")){
    bills.splice(i,1);
    localStorage.setItem('bills', JSON.stringify(bills));
    renderSummary();
  }
}

function printBill(i){
  const b = bills[i];
  const content = `
  <div style="text-align:center;">
    <h2>KIRTI JEWELS</h2><hr>
    <h3>Jewelry Bill</h3>
  </div>
  <table>
    <tr><th>Bill No</th><td>${b.billNo}</td></tr>
    <tr><th>Date</th><td>${b.date}</td></tr>
    <tr><th>KT</th><td>${b.kt}K</td></tr>
    <tr><th>Gross</th><td>${b.gross.toFixed(3)}</td></tr>
    <tr><th>CTW</th><td>${b.ctw.toFixed(3)}</td></tr>
    <tr><th>DWT</th><td>${b.dwt.toFixed(3)}</td></tr>
    <tr><th>Net</th><td>${b.net.toFixed(3)}</td></tr>
    <tr><th>Fine</th><td>${b.fine.toFixed(3)}</td></tr>
    <tr><th>Labour</th><td>‚Çπ${b.labour.toFixed(2)}</td></tr>
  </table><br>
  ${b.image ? `<img src="${b.image}" width="150">` : ''}
  `;
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>Print Bill</title>
  <style>body{font-family:'Times New Roman';padding:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:6px;text-align:left;}</style>
  </head><body>${content}</body></html>`);
  w.document.close(); w.print();
}

function printAllBills(){
  const content = bills.map(b => `
  <div style="page-break-after:always;text-align:center;">
    <h2>KIRTI JEWELS</h2><hr><h3>Jewelry Bill</h3>
    <table style="width:100%;border-collapse:collapse;border:1px solid #000;">
      <tr><th>Bill No</th><td>${b.billNo}</td></tr>
      <tr><th>Date</th><td>${b.date}</td></tr>
      <tr><th>KT</th><td>${b.kt}K</td></tr>
      <tr><th>Gross</th><td>${b.gross.toFixed(3)}</td></tr>
      <tr><th>CTW</th><td>${b.ctw.toFixed(3)}</td></tr>
      <tr><th>DWT</th><td>${b.dwt.toFixed(3)}</td></tr>
      <tr><th>Net</th><td>${b.net.toFixed(3)}</td></tr>
      <tr><th>Fine</th><td>${b.fine.toFixed(3)}</td></tr>
      <tr><th>Labour</th><td>‚Çπ${b.labour.toFixed(2)}</td></tr>
    </table><br>${b.image ? `<img src="${b.image}" width="150">` : ''}
  </div>
  `).join('');
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>All Bills</title></head><body>${content}</body></html>`);
  w.document.close(); w.print();
}

function downloadSummaryPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("KIRTI JEWELS Bill Summary",20,20);
  const columns = ["Bill No","Date","KT","Gross","CTW","DWT","Net","Fine","Labour"];
  const rows = bills.map(b => [b.billNo,b.date,b.kt+"K",b.gross.toFixed(3),b.ctw.toFixed(3),b.dwt.toFixed(3),b.net.toFixed(3),b.fine.toFixed(3),"‚Çπ"+b.labour.toFixed(2)]);
  doc.autoTable({ head:[columns], body:rows, startY:30 });
  let totalFine = bills.reduce((a,b)=>a+b.fine,0);
  let totalLabour = bills.reduce((a,b)=>a+b.labour,0);
  doc.autoTable({ startY: doc.lastAutoTable.finalY+2, head:[["","","","","","","Total",totalFine.toFixed(3),"‚Çπ"+totalLabour.toFixed(2)]], theme:'plain' });
  doc.save("Bill_Summary.pdf");
}

function downloadSummaryExcel(){
  const wb = XLSX.utils.book_new();
  const data = bills.map(b => ({
    "Bill No": b.billNo, "Date": b.date, "KT": b.kt+"K",
    "Gross": b.gross.toFixed(3), "CTW": b.ctw.toFixed(3),
    "DWT": b.dwt.toFixed(3), "Net": b.net.toFixed(3),
    "Fine": b.fine.toFixed(3), "Labour (‚Çπ)": b.labour.toFixed(2)
  }));
  const totalFine = bills.reduce((a,b)=>a+b.fine,0);
  const totalLabour = bills.reduce((a,b)=>a+b.labour,0);
  data.push({ "Net": "Total", "Fine": totalFine.toFixed(3), "Labour (‚Çπ)": totalLabour.toFixed(2) });
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "Summary");
  XLSX.writeFile(wb, "Bill_Summary.xlsx");
}
</script>
</body>
</html>
